I"ì<h3 id="hyperloglogç®€ä»‹">HyperLogLogç®€ä»‹</h3>
<p><a href="https://redis.io/topics/data-types-intro">Redis HyperLogLog</a>(ä»¥ä¸‹ç®€ç§°HLL)å®ç°äº†ä¸€ç§å«åšâ€œHyperLogLogâ€çš„ç®—æ³•ï¼Œå¹¶ä»¥Redisæ•°æ®ç»“æ„çš„å½¢å¼æä¾›ç»™å¼€å‘è€…ä½¿ç”¨ã€‚HLLåªåšä¸€ä»¶äº‹æƒ…ï¼Œå³ç»Ÿè®¡é›†åˆä¸­ä¸é‡å¤å…ƒç´ çš„ä¸ªæ•°ï¼ˆæœ¯è¯­å«åšé›†åˆåŸºæ•°ï¼‰ã€‚<br />
é›†åˆåŸºæ•°çš„ç»Ÿè®¡ç”¨Redisä¸­çš„setæ•°æ®ç»“æ„å’ŒJavaä¸­çš„Seté›†åˆç±»éƒ½å¯ä»¥å®ç°ï¼Œä½†æ˜¯ç”±äºå®ƒä»¬éƒ½ä¼šå®é™…å­˜å‚¨é›†åˆå…ƒç´ â€”â€”å­˜å‚¨ç©ºé—´æ­£æ¯”äºé›†åˆåŸºæ•°ï¼Œå› æ­¤å®ƒä»¬ä¸é€‚åˆé›†åˆåŸºæ•°æ¯”è¾ƒå¤§çš„åœºæ™¯ã€‚HLLä½¿ç”¨â€œç²¾åº¦æ¢ç©ºé—´â€çš„æƒè¡¡ç­–ç•¥ï¼Œå®ç°äº†ä»¥12kBçš„å¸¸é‡å­˜å‚¨ç©ºé—´å¼€é”€ï¼Œå¾—åˆ°æ ‡å‡†è¯¯ï¼ˆstandard errorï¼‰ä¸º0.81%çš„é›†åˆåŸºæ•°ä¼°è®¡å€¼ï¼Œå¹¶ä¸”é›†åˆåŸºæ•°çš„ä¸Šé™å¯ä»¥è¾¾åˆ°2^64ã€‚HLLä¸å­˜å‚¨é›†åˆå…ƒç´ ï¼Œåªå­˜å‚¨ä¸€ä¸ªåæ˜ å·²æ·»åŠ é›†åˆå…ƒç´ çš„çŠ¶æ€ï¼Œå› æ­¤èƒ½å¤Ÿå®ç°å¸¸é‡ç©ºé—´å¤æ‚åº¦ã€‚<br />
Redis HLLåœ¨å®ç°ä¸Šæ²¡æœ‰å¼•å…¥æ–°çš„æ•°æ®ç»“æ„ï¼Œè€Œæ˜¯å¤ç”¨äº†stringæ•°æ®ç»“æ„ï¼Œå³HLLåº•å±‚æ˜¯ç”¨stringç¼–ç çš„ã€‚</p>

<h4 id="ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹">ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹</h4>
<p>æœåŠ¡æ¯å¤©è¢«å¤šå°‘ä¸ªä¸é‡å¤çš„IPè®¿é—®è¿‡ï¼Ÿ<br />
æ¥å£æ¯æœˆè¢«å¤šå°‘ä¸ªä¸é‡å¤çš„ç”¨æˆ·IDè®¿é—®è¿‡ï¼Ÿ<br />
æœç´¢æ¯å¤©æ¥æ”¶åˆ°äº†å¤šå°‘ä¸ªä¸é‡å¤çš„æœç´¢è¯è¯·æ±‚ï¼Ÿ</p>

<h3 id="hyperloglogå‘½ä»¤">HyperLogLogå‘½ä»¤</h3>
<p>HLLçš„APIéå¸¸ç®€å•ï¼ŒåŒ…æ‹¬3æ¡å‘½ä»¤ï¼š</p>

<table>
  <thead>
    <tr>
      <th>command</th>
      <th>ä½œç”¨</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>PFADD</td>
      <td>å¾€HLLâ€œæ·»åŠ â€å…ƒç´ </td>
    </tr>
    <tr>
      <td>PFCOUNT</td>
      <td>è¯»å–HLLå½“å‰é›†åˆåŸºæ•°</td>
    </tr>
    <tr>
      <td>PFMERGE</td>
      <td>åˆå¹¶ä¸¤ä¸ªæˆ–å¤šä¸ªHLL</td>
    </tr>
  </tbody>
</table>

<h4 id="pfadd-å¾€hllæ·»åŠ å…ƒç´ "><a href="https://redis.io/commands/pfadd">PFADD</a>: å¾€HLLâ€œæ·»åŠ â€å…ƒç´ </h4>
<p>PFADD key [element [element â€¦]]</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>redis&gt;  PFADD hll a b c d e f g
<span class="o">(</span>integer<span class="o">)</span> 1
redis&gt;  PFCOUNT hll
<span class="o">(</span>integer<span class="o">)</span> 7
</code></pre></div></div>
<p><strong>è¿”å›å€¼</strong><br />
Integer reply, specifically:<br />
ã€€ã€€1 if at least 1 HyperLogLog internal register was altered. 0 otherwise.<br />
<strong>æ—¶é—´å¤æ‚åº¦</strong><br />
ã€€ã€€O(1)æ—¶é—´å¤æ‚åº¦<br />
PFADDå‘½ä»¤æ‰§è¡Œæ—¶ï¼Œå¦‚æœkeyè¿˜ä¸å­˜åœ¨å°±ä¼šå…ˆåˆ›å»ºä¸€ä¸ªç©ºçš„HLLï¼›ç„¶åæŠŠkeyåé¢çš„å…ƒç´ ï¼ˆå¦‚æœ‰ï¼‰â€œæ·»åŠ â€åˆ°HLLã€‚HLLå®é™…ä¸Šä¸ä¼šå­˜å‚¨PFADDå‘½ä»¤â€œæ·»åŠ â€è¿›æ¥çš„å…ƒç´ ï¼Œè€Œæ˜¯å¯¹å…ƒç´ è¿›è¡Œè®¡ç®—çœ‹æ˜¯å¦éœ€è¦æ›´æ–°å†…éƒ¨å¯„å­˜å™¨çŠ¶æ€ï¼ˆå¦‚æœéœ€è¦åˆ™æ›´æ–°å¯„å­˜å™¨å¹¶è¿”å›1ï¼Œå¦åˆ™è¿”å›0ï¼‰ã€‚æ‰€ä»¥ï¼Œæ— æ³•ä»HLLå–å‡ºä¹‹å‰é€šè¿‡PFADDå‘½ä»¤â€œæ·»åŠ â€è¿›å»çš„å…ƒç´ ã€‚</p>

<h4 id="pfcount-è¯»å–hllå½“å‰é›†åˆåŸºæ•°"><a href="https://redis.io/commands/pfcount">PFCOUNT</a>: è¯»å–HLLå½“å‰é›†åˆåŸºæ•°</h4>
<p>PFCOUNT key [key â€¦]</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>redis&gt;  PFADD hll foo bar zap
<span class="o">(</span>integer<span class="o">)</span> 1
redis&gt;  PFADD hll zap zap zap
<span class="o">(</span>integer<span class="o">)</span> 0
redis&gt;  PFADD hll foo bar
<span class="o">(</span>integer<span class="o">)</span> 0
redis&gt;  PFCOUNT hll
<span class="o">(</span>integer<span class="o">)</span> 3
redis&gt;  PFADD some-other-hll 1 2 3
<span class="o">(</span>integer<span class="o">)</span> 1
redis&gt;  PFCOUNT hll some-other-hll
<span class="o">(</span>integer<span class="o">)</span> 6
</code></pre></div></div>
<p><strong>è¿”å›å€¼</strong><br />
Integer reply, specifically:<br />
ã€€ã€€The approximated number of unique elements observed via PFADD.<br />
<strong>æ—¶é—´å¤æ‚åº¦</strong><br />
ã€€ã€€åªä¼ ä¸€ä¸ªkeyæ—¶O(1)æ—¶é—´å¤æ‚åº¦ï¼ˆå†…éƒ¨å¯ç¼“å­˜ï¼Œå¿«ï¼‰ï¼Œä¼ Nä¸ªkeyæ—¶O(N)æ—¶é—´å¤æ‚åº¦ï¼ˆæ— æ³•ç¼“å­˜ï¼Œæ¯«ç§’çº§çº§ï¼‰ã€‚<br />
å½“åªä¼ 1ä¸ªkeyæ—¶ï¼Œå¦‚æœé›†åˆåŸºæ•°çš„ç¼“å­˜å€¼æœ‰æ•ˆå°±ç›´æ¥è¿”å›ç¼“å­˜çš„é›†åˆåŸºæ•°ï¼Œå¦åˆ™è®¡ç®—é›†åˆåŸºæ•°å¹¶è¿”å›ï¼›å½“ä¼ å¤šä¸ªkeyæ—¶ï¼ŒRediså†…éƒ¨å…ˆæŠŠè¿™äº›keyå¯¹åº”HLLåˆå¹¶æˆå¾—åˆ°1ä¸ªä¸´æ—¶HLLï¼Œç„¶åè®¡ç®—å¹¶è¿”å›è¿™ä¸ªHLLçš„é›†åˆåŸºæ•°ã€‚</p>

<h4 id="pfmerge-åˆå¹¶ä¸¤ä¸ªæˆ–å¤šä¸ªhll"><a href="https://redis.io/commands/pfmerge">PFMERGE</a>: åˆå¹¶ä¸¤ä¸ªæˆ–å¤šä¸ªHLL</h4>
<p>PFMERGE destkey sourcekey [sourcekey â€¦]</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>redis&gt;  PFADD hll1 foo bar zap a
<span class="o">(</span>integer<span class="o">)</span> 1
redis&gt;  PFADD hll2 a b c foo
<span class="o">(</span>integer<span class="o">)</span> 1
redis&gt;  PFMERGE hll3 hll1 hll2
<span class="s2">"OK"</span>
redis&gt;  PFCOUNT hll3
<span class="o">(</span>integer<span class="o">)</span> 6
</code></pre></div></div>
<p><strong>è¿”å›å€¼</strong><br />
Simple string reply: The command just returns OK.<br />
<strong>æ—¶é—´å¤æ‚åº¦</strong><br />
ã€€ã€€åˆå¹¶Nä¸ªHLLæ—¶O(N)æ—¶é—´å¤æ‚åº¦<br />
æŠŠ1ä¸ªdestkeyå’Œå¤šä¸ªsourcekeyåˆå¹¶æˆ1ä¸ªHLLå¹¶å†™åˆ°destkeyä¸­ï¼Œå‘½ä»¤æ‰§è¡Œå®Œæˆæ—¶destkeyçš„é›†åˆåŸºæ•°ç­‰äºè¿™äº›é›†åˆçš„å¹¶é›†çš„é›†åˆåŸºæ•°å€¼ã€‚</p>

<p>HLLå†…éƒ¨ç”¨Redis stringç¼–ç ï¼Œå› æ­¤æ”¯æŒGETå’ŒSETå‘½ä»¤ã€‚åœ¨å¯¹HLLæ‰§è¡Œè¿™2ä¸ªå‘½ä»¤æ—¶ï¼ŒRedisä¼šè¿›è¡Œç›¸åº”çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ“ä½œã€‚</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>redis&gt; PFADD hll a b c d e f g
<span class="o">(</span>integer<span class="o">)</span> 1
redis&gt; get hll
<span class="s2">"HYLL</span><span class="se">\x</span><span class="s2">01</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">80Fm</span><span class="se">\x</span><span class="s2">80V</span><span class="se">\x</span><span class="s2">0c</span><span class="se">\x</span><span class="s2">80@</span><span class="se">\x</span><span class="s2">e9</span><span class="se">\x</span><span class="s2">80CQ</span><span class="se">\x</span><span class="s2">848</span><span class="se">\x</span><span class="s2">80P</span><span class="se">\x</span><span class="s2">b1</span><span class="se">\x</span><span class="s2">84I</span><span class="se">\x</span><span class="s2">8c</span><span class="se">\x</span><span class="s2">80Bm</span><span class="se">\x</span><span class="s2">80BZ"</span>
redis&gt; 
</code></pre></div></div>

<h3 id="hyperloglogåŸç†">HyperLogLogåŸç†</h3>
<p>Redis HLLçš„ç†è®ºæ¥æºæ˜¯å¦‚ä¸‹2ç¯‡æ–‡çŒ®ï¼š<br />
P. Flajolet, Ã‰ric Fusy, O. Gandouet, and F. Meunier. <a href="http://algo.inria.fr/flajolet/Publications/FlFuGaMe07.pdf">Hyperloglog: The  analysis of a near-optimal cardinality estimation algorithm</a>.<br />
Heule, Nunkesser, Hall: <a href="http://citeseerx.ist.psu.edu/viewdoc/download;jsessionid=30F1D3FD363452B76390182D2F5E58F0?doi=10.1.1.308.9527&amp;rep=rep1&amp;type=pdf">HyperLogLog in Practice: Algorithmic  Engineering of a State of The Art Cardinality Estimation Algorithm</a>.</p>

<hr />

<p>å‚è€ƒï¼š<br />
ã€ŠLinux Shellè„šæœ¬æ”»ç•¥ã€‹</p>

:ET